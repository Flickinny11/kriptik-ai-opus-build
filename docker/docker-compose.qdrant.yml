# Qdrant Vector Database for KripTik AI VL-JEPA Semantic Layer
# Version: Qdrant 1.16 with tiered multitenancy support
#
# Usage:
#   Development: docker-compose -f docker-compose.qdrant.yml --profile dev up -d
#   Production:  docker-compose -f docker-compose.qdrant.yml --profile prod up -d
#
# Ports:
#   6333 - HTTP API
#   6334 - gRPC API

version: '3.8'

services:
  # Development Qdrant instance (2GB memory limit)
  qdrant-dev:
    image: qdrant/qdrant:v1.16.0
    container_name: kriptik-qdrant-dev
    profiles:
      - dev
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_dev_storage:/qdrant/storage:z
      - ./qdrant-config/config.yaml:/qdrant/config/config.yaml:ro
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__LOG_LEVEL=INFO
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - kriptik-network

  # Production Qdrant instance (8GB memory limit, optimized settings)
  qdrant-prod:
    image: qdrant/qdrant:v1.16.0
    container_name: kriptik-qdrant-prod
    profiles:
      - prod
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_prod_storage:/qdrant/storage:z
      - ./qdrant-config/config.yaml:/qdrant/config/config.yaml:ro
      - ./qdrant-config/snapshots:/qdrant/snapshots:z
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__LOG_LEVEL=WARN
      - QDRANT__STORAGE__PERFORMANCE__MAX_SEARCH_THREADS=8
      - QDRANT__STORAGE__PERFORMANCE__MAX_OPTIMIZATION_THREADS=4
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 2G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: always
    networks:
      - kriptik-network

volumes:
  qdrant_dev_storage:
    driver: local
  qdrant_prod_storage:
    driver: local

networks:
  kriptik-network:
    driver: bridge
